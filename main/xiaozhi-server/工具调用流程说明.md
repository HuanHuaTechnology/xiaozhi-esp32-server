# ğŸ”§ å°æ™ºESP32å·¥å…·è°ƒç”¨æœºåˆ¶è¯¦è§£

## ğŸ“‹ è°ƒç”¨æµç¨‹æ¦‚è§ˆ

```mermaid
graph TD
    A[ç”¨æˆ·è¾“å…¥] --> B[connection.py: chat()]
    B --> C[è·å–å¯ç”¨å‡½æ•°åˆ—è¡¨]
    C --> D[func_handler.get_functions()]
    D --> E[è°ƒç”¨LLM with functions]
    E --> F[LLMè¿”å›å·¥å…·è°ƒç”¨]
    F --> G[è§£æå·¥å…·è°ƒç”¨å‚æ•°]
    G --> H[func_handler.handle_llm_function_call()]
    H --> I[tool_manager.execute_tool()]
    I --> J[æ’ä»¶æ‰§è¡Œå™¨å¤„ç†]
    J --> K[è¿”å›ç»“æœç»™ç”¨æˆ·]
```

## ğŸ¯ å…³é”®æ–‡ä»¶å’Œç±»

### 1. **è¿æ¥å¤„ç†** - `core/connection.py`
- `ConnectionHandler.chat()` - ä¸»è¦çš„å¯¹è¯å¤„ç†æ–¹æ³•
- ç¬¬618è¡Œï¼š`functions = self.func_handler.get_functions()`
- è´Ÿè´£è·å–å‡½æ•°åˆ—è¡¨å¹¶è°ƒç”¨LLM

### 2. **ç»Ÿä¸€å·¥å…·å¤„ç†å™¨** - `core/providers/tools/unified_tool_handler.py`
- `UnifiedToolHandler` - ç®¡ç†æ‰€æœ‰ç±»å‹çš„å·¥å…·
- `get_functions()` - è¿”å›å¯ç”¨å‡½æ•°åˆ—è¡¨
- `handle_llm_function_call()` - å¤„ç†LLMçš„å‡½æ•°è°ƒç”¨

### 3. **å·¥å…·ç®¡ç†å™¨** - `core/providers/tools/unified_tool_manager.py`
- `ToolManager` - ç»Ÿä¸€ç®¡ç†ä¸åŒç±»å‹çš„å·¥å…·
- `get_function_descriptions()` - è·å–OpenAIæ ¼å¼çš„å‡½æ•°æè¿°
- `execute_tool()` - æ‰§è¡Œå…·ä½“çš„å·¥å…·è°ƒç”¨

### 4. **æ’ä»¶æ³¨å†Œ** - `plugins_func/register.py`
- `@register_function` - è£…é¥°å™¨æ³¨å†Œå‡½æ•°
- `all_function_registry` - å…¨å±€å‡½æ•°æ³¨å†Œè¡¨

### 5. **å¤©æ°”æ’ä»¶** - `plugins_func/functions/get_weather.py`
- ä½¿ç”¨ `@register_function` è£…é¥°å™¨
- å®ç°å…·ä½“çš„å¤©æ°”æŸ¥è¯¢é€»è¾‘

## ğŸ” è°ƒè¯•æ—¥å¿—è§£è¯»

### æ­£å¸¸å·¥ä½œæ—¶åº”è¯¥çœ‹åˆ°çš„æ—¥å¿—ï¼š

```log
[INFO] ğŸ› ï¸  è·å–åˆ° 4 ä¸ªå¯ç”¨å‡½æ•°
[INFO]    1. get_weather - è·å–æŸä¸ªåœ°ç‚¹çš„å¤©æ°”ï¼Œç”¨æˆ·åº”æä¾›ä¸€ä¸ªä½ç½®ï¼Œæ¯”å¦‚ç”¨æˆ·è¯´æ­å·å¤©æ°”...
[INFO]    2. handle_exit_intent - å¤„ç†é€€å‡ºæ„å›¾...
[INFO]    3. get_time - è·å–å½“å‰æ—¶é—´...
[INFO]    4. get_lunar - è·å–å†œå†ä¿¡æ¯...

[INFO] ğŸ¤– æ­£åœ¨è°ƒç”¨æ”¯æŒå‡½æ•°çš„LLMæ¥å£ï¼Œå‡½æ•°æ•°é‡: 4
[INFO] ğŸ”§ æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨ï¼š1 ä¸ªå·¥å…·
[INFO]    ğŸ†” å‡½æ•°ID: abc123
[INFO]    ğŸ“ å‡½æ•°å: get_weather
[INFO]    ğŸ“„ å‡½æ•°å‚æ•°: {"location": "å¹¿å·"}

[INFO] ğŸš€ å‡†å¤‡æ‰§è¡Œå‡½æ•°è°ƒç”¨:
[INFO]    ğŸ“ å‡½æ•°å: get_weather
[INFO]    ğŸ†” å‡½æ•°ID: abc123
[INFO]    ğŸ“„ å‚æ•°: {"location": "å¹¿å·"}

[INFO] âœ… func_handler å¯ç”¨ï¼Œå¼€å§‹æ‰§è¡Œ...
[INFO] ğŸ¯ å‡½æ•°æ‰§è¡Œç»“æœ: REQLLM
```

### å‡ºç°é—®é¢˜æ—¶çš„æ—¥å¿—ï¼š

```log
[WARNING] ğŸš« æ— æ³•è·å–å‡½æ•°: intent_type=function_call, has_func_handler=False
[INFO] ğŸ’¬ ä½¿ç”¨æ™®é€šLLMæ¥å£ï¼ˆæ— å‡½æ•°æ”¯æŒï¼‰
[ERROR] âŒ func_handler ä¸å¯ç”¨! hasattr=False, is_none=True
```

## ğŸ› ï¸ å·¥å…·ç±»å‹åˆ†ç±»

é¡¹ç›®æ”¯æŒ5ç§ç±»å‹çš„å·¥å…·ï¼š

### 1. **SERVER_PLUGIN** - æœåŠ¡ç«¯æ’ä»¶
- å¤©æ°”æŸ¥è¯¢ï¼š`get_weather`
- æ—¶é—´è·å–ï¼š`get_time`
- å†œå†æŸ¥è¯¢ï¼š`get_lunar`
- é€€å‡ºå¤„ç†ï¼š`handle_exit_intent`

### 2. **SERVER_MCP** - æœåŠ¡ç«¯MCP
- è¿è¡Œåœ¨æœåŠ¡å™¨ç«¯çš„MCPæœåŠ¡
- é€šè¿‡ `mcp_server_settings.json` é…ç½®

### 3. **DEVICE_IOT** - è®¾å¤‡IoTæ§åˆ¶
- è®¾å¤‡çŠ¶æ€æŸ¥è¯¢
- éŸ³é‡æ§åˆ¶ã€å±å¹•äº®åº¦ç­‰

### 4. **DEVICE_MCP** - è®¾å¤‡ç«¯MCP
- å®¢æˆ·ç«¯è®¾å¤‡æä¾›çš„MCPå·¥å…·
- é€šè¿‡WebSocketæ¶ˆæ¯ä¼ é€’

### 5. **MCP_ENDPOINT** - MCPæ¥å…¥ç‚¹
- å¤–éƒ¨MCPæœåŠ¡æ¥å…¥
- æ”¯æŒWebSocketè¿æ¥

## ğŸ§ª æµ‹è¯•å’Œè°ƒè¯•

### è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š
```bash
cd main/xiaozhi-server
python test_tool_calling.py
```

### æ‰‹åŠ¨æµ‹è¯•å‘½ä»¤ï¼š
- `"ä»Šå¤©å¹¿å·å¤©æ°”æ€ä¹ˆæ ·"` - åº”è¯¥è§¦å‘å¤©æ°”å·¥å…·
- `"ä½ å¥½å—"` - ä¸åº”è¯¥è§¦å‘å·¥å…·
- `"ç°åœ¨å‡ ç‚¹äº†"` - åº”è¯¥è§¦å‘æ—¶é—´å·¥å…·

### æ£€æŸ¥é…ç½®ï¼š
```bash
# æŸ¥çœ‹å¤©æ°”æ’ä»¶é…ç½®
grep -A 5 "get_weather" config.yaml

# æŸ¥çœ‹æ„å›¾è¯†åˆ«é…ç½®
grep -A 10 "Intent_function_call" config.yaml
```

## âŒ å¸¸è§é—®é¢˜æ’æŸ¥

### 1. "æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°"
- æ£€æŸ¥ `func_handler` æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
- ç¡®è®¤æ’ä»¶æ˜¯å¦æ­£ç¡®æ³¨å†Œ
- æŸ¥çœ‹ `intent_type` æ˜¯å¦ä¸º `function_call`

### 2. "cannot schedule new futures after shutdown"
- Dockerç¯å¢ƒèµ„æºç®¡ç†é—®é¢˜
- è¿æ¥å…³é—­æ—¶è¿‡åº¦æ¸…ç†å¯¼è‡´

### 3. å‡½æ•°åˆ—è¡¨ä¸ºç©º
- æ£€æŸ¥æ’ä»¶è‡ªåŠ¨å¯¼å…¥æ˜¯å¦æˆåŠŸ
- ç¡®è®¤é…ç½®æ–‡ä»¶ä¸­çš„æ’ä»¶åˆ—è¡¨
- æŸ¥çœ‹loguruä¾èµ–æ˜¯å¦å®‰è£…

## ğŸ”§ é…ç½®è¦ç‚¹

### config.yaml å…³é”®é…ç½®ï¼š
```yaml
# æ„å›¾è¯†åˆ«æ¨¡å¼
Intent:
  Intent_function_call:
    type: "function_call"  # å¯ç”¨å‡½æ•°è°ƒç”¨
    functions:             # å¯ç”¨å‡½æ•°åˆ—è¡¨
      - get_weather
      - get_time
      - get_lunar

# æ’ä»¶é…ç½®
plugins:
  get_weather:
    api_host: "pr4nmrxuff.re.qweatherapi.com"
    api_key: "your_api_key"
    default_location: "å¹¿å·"
```

## ğŸ“Š æ€§èƒ½ç›‘æ§

å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç›‘æ§å·¥å…·è°ƒç”¨æ€§èƒ½ï¼š

```python
# è·å–å·¥å…·ç»Ÿè®¡ä¿¡æ¯
conn.func_handler.get_tool_statistics()

# åˆ·æ–°å·¥å…·ç¼“å­˜
conn.func_handler.tool_manager.refresh_tools()

# è·å–æ”¯æŒçš„å·¥å…·åç§°
conn.func_handler.current_support_functions()
```

---

ğŸ’¡ **æç¤º**ï¼šæ·»åŠ è°ƒè¯•æ‰“å°åï¼Œé‡å¯æœåŠ¡å™¨å¹¶è¿›è¡Œå¤©æ°”æŸ¥è¯¢æµ‹è¯•ï¼Œè§‚å¯Ÿå®Œæ•´çš„å·¥å…·è°ƒç”¨æµç¨‹ï¼ 