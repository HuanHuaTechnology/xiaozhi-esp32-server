# 🔧 小智ESP32工具调用机制详解

## 📋 调用流程概览

```mermaid
graph TD
    A[用户输入] --> B[connection.py: chat()]
    B --> C[获取可用函数列表]
    C --> D[func_handler.get_functions()]
    D --> E[调用LLM with functions]
    E --> F[LLM返回工具调用]
    F --> G[解析工具调用参数]
    G --> H[func_handler.handle_llm_function_call()]
    H --> I[tool_manager.execute_tool()]
    I --> J[插件执行器处理]
    J --> K[返回结果给用户]
```

## 🎯 关键文件和类

### 1. **连接处理** - `core/connection.py`
- `ConnectionHandler.chat()` - 主要的对话处理方法
- 第618行：`functions = self.func_handler.get_functions()`
- 负责获取函数列表并调用LLM

### 2. **统一工具处理器** - `core/providers/tools/unified_tool_handler.py`
- `UnifiedToolHandler` - 管理所有类型的工具
- `get_functions()` - 返回可用函数列表
- `handle_llm_function_call()` - 处理LLM的函数调用

### 3. **工具管理器** - `core/providers/tools/unified_tool_manager.py`
- `ToolManager` - 统一管理不同类型的工具
- `get_function_descriptions()` - 获取OpenAI格式的函数描述
- `execute_tool()` - 执行具体的工具调用

### 4. **插件注册** - `plugins_func/register.py`
- `@register_function` - 装饰器注册函数
- `all_function_registry` - 全局函数注册表

### 5. **天气插件** - `plugins_func/functions/get_weather.py`
- 使用 `@register_function` 装饰器
- 实现具体的天气查询逻辑

## 🔍 调试日志解读

### 正常工作时应该看到的日志：

```log
[INFO] 🛠️  获取到 4 个可用函数
[INFO]    1. get_weather - 获取某个地点的天气，用户应提供一个位置，比如用户说杭州天气...
[INFO]    2. handle_exit_intent - 处理退出意图...
[INFO]    3. get_time - 获取当前时间...
[INFO]    4. get_lunar - 获取农历信息...

[INFO] 🤖 正在调用支持函数的LLM接口，函数数量: 4
[INFO] 🔧 检测到工具调用：1 个工具
[INFO]    🆔 函数ID: abc123
[INFO]    📝 函数名: get_weather
[INFO]    📄 函数参数: {"location": "广州"}

[INFO] 🚀 准备执行函数调用:
[INFO]    📝 函数名: get_weather
[INFO]    🆔 函数ID: abc123
[INFO]    📄 参数: {"location": "广州"}

[INFO] ✅ func_handler 可用，开始执行...
[INFO] 🎯 函数执行结果: REQLLM
```

### 出现问题时的日志：

```log
[WARNING] 🚫 无法获取函数: intent_type=function_call, has_func_handler=False
[INFO] 💬 使用普通LLM接口（无函数支持）
[ERROR] ❌ func_handler 不可用! hasattr=False, is_none=True
```

## 🛠️ 工具类型分类

项目支持5种类型的工具：

### 1. **SERVER_PLUGIN** - 服务端插件
- 天气查询：`get_weather`
- 时间获取：`get_time`
- 农历查询：`get_lunar`
- 退出处理：`handle_exit_intent`

### 2. **SERVER_MCP** - 服务端MCP
- 运行在服务器端的MCP服务
- 通过 `mcp_server_settings.json` 配置

### 3. **DEVICE_IOT** - 设备IoT控制
- 设备状态查询
- 音量控制、屏幕亮度等

### 4. **DEVICE_MCP** - 设备端MCP
- 客户端设备提供的MCP工具
- 通过WebSocket消息传递

### 5. **MCP_ENDPOINT** - MCP接入点
- 外部MCP服务接入
- 支持WebSocket连接

## 🧪 测试和调试

### 运行测试脚本：
```bash
cd main/xiaozhi-server
python test_tool_calling.py
```

### 手动测试命令：
- `"今天广州天气怎么样"` - 应该触发天气工具
- `"你好吗"` - 不应该触发工具
- `"现在几点了"` - 应该触发时间工具

### 检查配置：
```bash
# 查看天气插件配置
grep -A 5 "get_weather" config.yaml

# 查看意图识别配置
grep -A 10 "Intent_function_call" config.yaml
```

## ❌ 常见问题排查

### 1. "没有找到对应的函数"
- 检查 `func_handler` 是否正确初始化
- 确认插件是否正确注册
- 查看 `intent_type` 是否为 `function_call`

### 2. "cannot schedule new futures after shutdown"
- Docker环境资源管理问题
- 连接关闭时过度清理导致

### 3. 函数列表为空
- 检查插件自动导入是否成功
- 确认配置文件中的插件列表
- 查看loguru依赖是否安装

## 🔧 配置要点

### config.yaml 关键配置：
```yaml
# 意图识别模式
Intent:
  Intent_function_call:
    type: "function_call"  # 启用函数调用
    functions:             # 可用函数列表
      - get_weather
      - get_time
      - get_lunar

# 插件配置
plugins:
  get_weather:
    api_host: "pr4nmrxuff.re.qweatherapi.com"
    api_key: "your_api_key"
    default_location: "广州"
```

## 📊 性能监控

可以通过以下方式监控工具调用性能：

```python
# 获取工具统计信息
conn.func_handler.get_tool_statistics()

# 刷新工具缓存
conn.func_handler.tool_manager.refresh_tools()

# 获取支持的工具名称
conn.func_handler.current_support_functions()
```

---

💡 **提示**：添加调试打印后，重启服务器并进行天气查询测试，观察完整的工具调用流程！ 